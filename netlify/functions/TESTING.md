# Тестирование перед деплоем на Netlify

## Описание

Этот раздел содержит тесты для проверки работоспособности API перед деплоем на Netlify. Тесты проверяют:

1. Загрузку данных из JSON файла
2. Работу API с различными типами запросов
3. Фильтрацию по городам
4. Расчет стоимости доставки
5. Обработку CORS заголовков
6. Обработку ошибок
7. Формат ответа для InSales
8. Производительность
9. Синхронизацию с HTML файлом

## Структура тестов

### 1. `test-local.js` - Базовые тесты
- Проверка загрузки данных из JSON файла
- Проверка информационного запроса к API
- Проверка фильтрации по городу
- Проверка расчета стоимости доставки
- Проверка обработки CORS заголовков
- Проверка обработки ошибок

### 2. `test-extended.js` - Расширенные тесты
- Проверка фильтрации городов с различными форматами названий
- Проверка работы с различными полями адреса
- Проверка формата ответа для InSales
- Проверка граничных значений веса
- Проверка производительности
- Проверка синхронизации с HTML файлом

### 3. `run-tests.js` - Скрипт запуска всех тестов

## Запуск тестов

### Локальный запуск всех тестов:
```bash
cd netlify/functions
node run-tests.js
```

### Запуск базовых тестов:
```bash
cd netlify/functions
node test-local.js
```

### Запуск расширенных тестов:
```bash
cd netlify/functions
node test-extended.js
```

## Интеграция с Netlify

Для автоматического запуска тестов перед деплоем добавьте в `netlify.toml`:

```toml
[build]
  command = "cd netlify/functions && npm test && cd ../.."

[[plugins]]
  package = "@netlify/plugin-functions-core"
```

Или добавьте скрипт в `package.json`:

```json
{
  "scripts": {
    "test": "node netlify/functions/run-tests.js",
    "prebuild": "npm test"
  }
}
```

## Уровни тестирования

### Уровень 1: Обязательные тесты
- Загрузка данных из JSON
- Базовая работа API
- Обработка CORS

### Уровень 2: Функциональные тесты
- Фильтрация по городам
- Расчет стоимости
- Формат ответа

### Уровень 3: Интеграционные тесты
- Совместимость с InSales
- Обработка различных форматов данных
- Производительность

## Пороги прохождения тестов

- **Зеленый уровень**: Все обязательные тесты проходят
- **Желтый уровень**: Есть предупреждения, но основная функциональность работает
- **Красный уровень**: Один или несколько обязательных тестов не проходят

## Отчет о тестировании

После выполнения тестов создается отчет с указанием:

- Количества пройденных/непройденных тестов
- Времени выполнения
- Обнаруженных проблем
- Рекомендаций по исправлению

## Автоматизация

Для автоматизации тестирования в CI/CD системах:

```yaml
test:
  stage: test
  script:
    - cd netlify/functions
    - node run-tests.js
  only:
    - develop
    - master
```

## Рекомендации

1. Запускайте тесты перед каждым коммитом
2. Запускайте тесты перед каждым пул-реквестом
3. Запускайте тесты перед каждым деплоем
4. Обновляйте тесты при изменении API
5. Добавляйте новые тесты при добавлении новой функциональности