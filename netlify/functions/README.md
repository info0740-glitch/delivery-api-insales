# Система управления пунктами выдачи

## Описание

Эта система предназначена для управления пунктами выдачи заказов (ПВЗ) для службы доставки Avtolayt Express. Данные хранятся в отдельном JSON файле, что упрощает обновление и поддержку.

## Структура файлов

- `server.js` - Основной серверный файл, который загружает данные из JSON файла
- `pickup-points.json` - Файл с данными о пунктах выдачи
- `sync-pickup-points.js` - Скрипт для синхронизации данных с HTML файлом
- `update-pickup-points.js` - Скрипт для обновления пунктов (устаревший)
- `clean-json.js` - Скрипт для очистки JSON файла от лишних полей
- `test-load.js` - Тестовый скрипт для проверки загрузки данных
- `test-local.js` - Базовые тесты для проверки работоспособности перед деплоем
- `test-extended.js` - Расширенные тесты для проверки различных сценариев работы
- `run-tests.js` - Скрипт для запуска всех тестов перед деплоем
- `prepare-and-test.js` - Скрипт подготовки и запуска тестов
- `TESTING.md` - Документация по тестированию

## Формат данных

Каждый пункт выдачи в JSON файле имеет следующую структуру:

```json
{
  "id": 10201,
  "city": "Барановичи",
  "name": "СППС №10201",
  "address": "г.Барановичи, ул.50 лет БССР, д.31",
  "working_hours": "Пн-Сб: с 10:00 до 20:00 обед 14:00 до 14:30",
  "delivery_address": "г.Барановичи, ул.50 лет БССР, д.31, Беларусь"
}
```

## Использование

### 1. Синхронизация с HTML файлом

Для обновления данных на основе HTML файла используйте:

```bash
cd netlify/functions
node sync-pickup-points.js
```

Скрипт автоматически:
- Парсит HTML файл `pickup_points_20260202_095340.html`
- Сравнивает текущие данные с новыми
- Добавляет недостающие пункты
- Сортирует данные по ID
- Сохраняет обновленный JSON файл

### 2. Проверка загрузки данных

Для проверки корректности загрузки данных используйте:

```bash
cd netlify/functions
node test-load.js
```

### 3. Тестирование перед деплоем

Для полной проверки работоспособности системы перед деплоем на Netlify используйте:

```bash
cd netlify/functions
node run-tests.js
```

Или запустите подготовку и тестирование:

```bash
cd netlify/functions
node prepare-and-test.js
```

### 4. Ручное обновление

Если необходимо вручную добавить пункт выдачи, отредактируйте файл `pickup-points.json`:

```json
[
  {
    "id": 99999,
    "city": "Новый Город",
    "name": "СППС №99999",
    "address": "г. Новый Город, ул. Примерная, д.1",
    "working_hours": "Пн-Пт: с 10:00 до 18:00",
    "delivery_address": "г. Новый Город, ул. Примерная, д.1, Беларусь"
  }
]
```

## Тестирование

Система включает комплексное тестирование перед деплоем:

### Базовые тесты (`test-local.js`)
- Проверка загрузки данных из JSON файла
- Проверка информационного запроса к API
- Проверка фильтрации по городу
- Проверка расчета стоимости доставки
- Проверка обработки CORS заголовков
- Проверка обработки ошибок

### Расширенные тесты (`test-extended.js`)
- Проверка фильтрации городов с различными форматами названий
- Проверка работы с различными полями адреса
- Проверка формата ответа для InSales
- Проверка граничных значений веса
- Проверка производительности
- Проверка синхронизации с HTML файлом

## Особенности реализации

### Загрузка данных

Сервер загружает данные из JSON файла при каждом запуске:

```javascript
function loadPickupPoints() {
  try {
    const filePath = path.join(__dirname, 'pickup-points.json');
    const data = fs.readFileSync(filePath, 'utf8');
    return JSON.parse(data);
  } catch (error) {
    console.error('Ошибка загрузки пунктов выдачи:', error);
    return [];
  }
}
```

### Фильтрация городов

Реализована умная фильтрация городов с поддержкой:
- Точных совпадений
- Частичных совпадений
- Удаления префиксов (г., город, п., с.)
- Нормализации названий

### Обработка ошибок

- При ошибке загрузки JSON файл возвращается пустой массив
- При отсутствии данных возвращается список основных городов
- Все ошибки логируются в консоль

## Интеграция с Netlify

### Файлы для деплоя

Для работы API на Netlify необходимо загрузить следующие файлы:

- `server.js` - основной файл API
- `pickup-points.json` - данные о пунктах выдачи
- `sync-pickup-points.js` - скрипт синхронизации (при необходимости)

### Файлы для тестирования (локально)

Следующие файлы используются только для локального тестирования перед деплоем и НЕ должны загружаться на Netlify:

- `test-local.js` - базовые тесты
- `test-extended.js` - расширенные тесты
- `run-tests.js` - скрипт запуска всех тестов
- `prepare-and-test.js` - скрипт подготовки и запуска тестов
- `TESTING.md` - документация по тестированию
- `run-tests.bat`, `run-tests.sh` - скрипты запуска для разных ОС

### Настройка деплоя

Для автоматического запуска тестов перед деплоем добавьте в `package.json`:

```json
{
  "scripts": {
    "test": "node netlify/functions/run-tests.js",
    "prebuild": "npm test"
  }
}
```

Или в `netlify.toml`:

```toml
[build]
  command = "cd netlify/functions && node prepare-and-test.js && cd ../.. && npm run build"
```

### Игнорирование файлов

Для исключения тестовых файлов из деплоя используйте файл `.netlifyignore`:

```
# Файлы тестирования
test-local.js
test-extended.js
run-tests.js
prepare-and-test.js
run-tests.bat
run-tests.sh
TESTING.md
```

## Технические детали

- **Node.js**: Версия 14+
- **Формат данных**: JSON
- **Кодировка**: UTF-8
- **Максимальное количество пунктов**: 66 (на текущий момент)
- **Количество городов**: 34 (на текущий момент)

## История изменений

- Версия 1.0: Initial release
- Добавлена поддержка загрузки из JSON файла
- Реализована автоматическая синхронизация с HTML
- Удалены поля с телефонами (не требуются для API)
- Добавлена обработка ошибок и логирование
- Добавлена система тестирования перед деплоем